# できること

箱庭ドローンシミュレータでは、以下を自動化できます。

* 箱庭シミュレータ内部のコンポーネント（センサや物理モデルなど）のテスト
* ドローン制御プログラムのテスト
* 機体パラメータのチューニング・テスト

# 自動テストシステムのアーキテクチャ

<img width="929" alt="スクリーンショット 2023-12-29 10 59 02" src="https://github.com/toppers/hakoniwa-px4sim/assets/164193/6115dfa5-8cf6-47ff-b6d6-843aca488422">

自動テストシステムは、複数のコンポーネントから構成され、ドローンの動作テスト、機体パラメータのチューニング、ドローン制御プログラムの検証を可能にします。以下の説明は、システムの各コンポーネントとその機能を明確にします。

- **Drone Parameter Generator**: 
  機体のパラメータをテスト開始時に生成し、テストの各イテレーションで異なる機体特性をシミュレートできるようにします。

- **Test Scenario**: 
  定義されたテストシナリオを含むドキュメントです。ここには、テストの操作手順が記述されています。

- **Test Scenario Executor**: 
  テストシナリオに従って、`Hakoniwa` と `PX4` 内部の機体制御プログラムを用いてテストを実行します。

- **Hakoniwa**: 
  箱庭シミュレーション環境で、テストシナリオに基づきドローンの動作をシミュレートするコンポーネントです。箱庭シミュレーション内部の各種コンポーネント（センサや物理モデルなど）をテストできます。

- **PX4**: 
  ドローンのフライトコントロールソフトウェアであり、ドローンの飛行を制御します。PX4内部の各種コンポーネント（機体制御プログラム）をテストできます。

- **Logs / LogOutputDirectory**: 
  テスト実行中に生成される詳細なログファイル（センサモデルや物理モデルの内部ログデータ）で、テスト評価するために利用します。

- **Test Result Evaluator**: 
  テストの実行結果であるログ情報解析し、成功または失敗の結果を `Test Result` に記録します。

これらのコンポーネントは連携して動作し、柔軟かつ精密なテストを実現します。結果として、開発プロセスが大幅に加速されます。

## Drone Parameter Generator

[機体のパラメータ](https://github.com/toppers/hakoniwa-px4sim/blob/main/hakoniwa/README.md#機体のパラメータ説明)は、[drone_config.py](https://github.com/toppers/hakoniwa-px4sim/blob/main/hakoniwa/python/drone_config.py)で設定できます。

このスクリプトを使用して、指定されたJSONファイル内の値を更新できます。

### 使い方

スクリプトはコマンドラインから次のように実行されます：

```
python drone_config.py <json_file> <path> <new_value>
```

### 引数

- `json_file`: 更新するJSONファイルへのパスを指定します。
- `path`: 更新する要素へのドット区切りパス。例えば、`components.droneDynamics.mass_kg`のように指定します。
- `new_value`: 要素に設定する新しい値。値の型は自動的に元の値の型に合わせて変換されます。

### 値の型変換

プログラムは、新しい値を次のルールに従って適切な型に変換します：

- 整数（`int`）への変換が必要な場合、新しい値は整数に変換されます。
- 浮動小数点数（`float`）への変換が必要な場合、新しい値は浮動小数点数に変換されます。
- 文字列（`str`）への変換が必要な場合、新しい値は文字列に変換されます。
- 真偽値（`bool`）への変換が必要な場合、`"true"`または`"false"`の文字列が真偽値に変換されます。
- JSON配列やオブジェクトなど、その他のデータ型を更新する場合、適切なJSON形式の文字列を使用します（例: `'[0.015, 0.015, 0.03]'`）。

### エラーハンドリング

- もし指定したパスが存在しない場合、プログラムはエラーメッセージを出力します。
- もし指定したキーが存在しない場合、プログラムはエラーメッセージを出力します。
- 型変換に失敗した場合、プログラムはエラーメッセージを出力します。

### 実行例

JSONファイル内の`components.droneDynamics.mass_kg`の値を`1.5`に更新するには、次のコマンドを実行します：

```
python drone_config.py path_to_file.json components.droneDynamics.mass_kg 1.5
```

### 注意

- このスクリプトは、コマンドライン引数として有効なJSONファイルのパスと、更新する要素の有効なパス、そして有効な新しい値が提供されることを前提としています。
- JSONファイルはプログラムによって上書きされます。元のファイルのバックアップを取っておくことを推奨します。


## Test Scenario

テストシナリオは、ドローンの飛行テストを自動化するためにJSON形式で定義されます。各シナリオは、特定の操作とその操作に必要なパラメータを含むオブジェクトのリストです。

### シナリオの形式

テストシナリオは以下の形式で定義します：

```json
{
    "scenario": [
        {
            "operation": "<操作名>",
            "param1": <値1>,
            "param2": <値2>,
            ...
        },
        ...
    ]
}
```

### オペレーション項目

テストシナリオでは、以下のオペレーション項目を設定できます：

* takeoff: ドローンに離陸命令を出します。
* start_landing: ドローンに特定の位置に向かって移動します。

現時点でサポートされているオペレーションは takeoff と start_landing のみです。

#### takeoff

離陸を指示します。

* alt: 離陸後の目標高度。単位はメートル(m)。
* duration_sec: 離陸操作を続ける時間。単位は秒(sec)。

#### start_landing

移動を指示します。

* lat: 初期位置の緯度からの相対位置。単位はメートル(m)。
* lon: 初期位置の経度からの相対位置。単位はメートル(m)。
* alt: 初期位置の高度からの相対位置。単位はメートル(m)。
* duration_sec: 移動操作を続ける時間。単位は秒(sec)。

### 設定例

* [takeoff](https://github.com/toppers/hakoniwa-px4sim/blob/main/px4/auto-test/test_scenario/takeoff.json)
  * 離陸指示を出し、5m上昇してホバリングを続けます。20秒経過するとこのオペレーションは終了します。
* [takeoff_and_move.json](https://github.com/toppers/hakoniwa-px4sim/blob/main/px4/auto-test/test_scenario/takeoff_and_move.json)
  * 離陸指示を出し、10m上昇してホバリングを続けます。その後、東→北→西→南の順番で10m移動し続けます。各オペレーションは20秒間持続します。 

## Test Scenario Executor

このプログラムは、MAVLinkを介してPX4フライトコントローラと通信し、JSON形式で定義されたテストシナリオに基づいてドローンの飛行テストを自動的に実行します。

### プログラムの概要

- テストシナリオ実行プログラムは、3つのJSONファイルを引数として受け取ります：
  - コンフィグファイル：MAVLink接続設定が含まれます。
  - ドローンコンフィグファイル：ドローンの物理特性やセンサー設定が含まれます。
  - テストシナリオファイル：実行する操作のシーケンスが定義されています。

- このプログラムは、シグナルハンドラを使用して適切なシャットダウンを保証します。

### 使用方法

コマンドラインから以下のようにプログラムを実行します：

```
python hako_QgcStub.py <config_path> <drone_config_path> <test_scenario_path>
```

- `config_path`: MAVLink接続設定を含むJSONファイルへのパス。
- `drone_config_path`: ドローンの設定を含むJSONファイルへのパス。
- `test_scenario_path`: テストシナリオを含むJSONファイルへのパス。

### 主要な機能

- **QgcStub**: QGroundControlのスタブ機能を提供し、定期的にハートビートとピングメッセージをPX4に送信します。
- **Px4Receiver**: PX4からのメッセージをリッスンし、適切なイベントをシナリオマネージャに通知します。

### シナリオマネージャ

- シナリオマネージャは、テストシナリオをロードし、指定された操作を順番に実行します。
- 各操作が完了すると、次の操作が自動的に開始されます。

### マルチスレッド実行

- プログラムはマルチスレッドで実行され、一方のスレッドがPX4からのメッセージをリッスンし、もう一方のスレッドがシナリオを実行します。

### エラーハンドリング

- もしサポートされていない操作がロードされた場合、プログラムはエラーメッセージを出力し、終了します。
- プログラムはシグナル（例えば、Ctrl+C）によって中断された場合、適切にシャットダウンするように設計されています。

### 注意

- このプログラムは、有効なJSONファイルのパスと正しいフォーマットのテストシナリオが提供されることを前提としています。
- テストシナリオの実行中にプログラムを中断する場合は、シグナルを送信してください。


## Logs / LogOutputDirectory

TODO

## Test Result Evaluator

TODO

# テスト実行方法

TODO

