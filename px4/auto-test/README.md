# できること

箱庭ドローンシミュレータでは、以下を自動化できます。

* 箱庭シミュレータ内部のコンポーネント（センサや物理モデルなど）のテスト
* ドローン制御プログラムのテスト
* 機体パラメータのチューニング・テスト

# 自動テストシステムのアーキテクチャ

<img width="929" alt="スクリーンショット 2023-12-29 10 59 02" src="https://github.com/toppers/hakoniwa-px4sim/assets/164193/6115dfa5-8cf6-47ff-b6d6-843aca488422">

自動テストシステムは、複数のコンポーネントから構成され、ドローンの動作テスト、機体パラメータのチューニング、ドローン制御プログラムの検証を可能にします。以下の説明は、システムの各コンポーネントとその機能を明確にします。

- **Drone Parameter Generator**: 
  機体のパラメータをテスト開始時に生成し、テストの各イテレーションで異なる機体特性をシミュレートできるようにします。

- **Test Scenario**: 
  定義されたテストシナリオを含むドキュメントです。ここには、テストの操作手順が記述されています。

- **Test Scenario Executor**: 
  テストシナリオに従って、`Hakoniwa` と `PX4` 内部の機体制御プログラムを用いてテストを実行します。

- **Hakoniwa**: 
  箱庭シミュレーション環境で、テストシナリオに基づきドローンの動作をシミュレートするコンポーネントです。箱庭シミュレーション内部の各種コンポーネント（センサや物理モデルなど）をテストできます。

- **PX4**: 
  ドローンのフライトコントロールソフトウェアであり、ドローンの飛行を制御します。PX4内部の各種コンポーネント（機体制御プログラム）をテストできます。

- **Logs / LogOutputDirectory**: 
  テスト実行中に生成される詳細なログファイル（センサモデルや物理モデルの内部ログデータ）で、テスト評価するために利用します。

- **Test Result Evaluator**: 
  テストの実行結果であるログ情報解析し、成功または失敗の結果を `Test Result` に記録します。

これらのコンポーネントは連携して動作し、柔軟かつ精密なテストを実現します。結果として、開発プロセスが大幅に加速されます。

## Drone Parameter Generator

[機体のパラメータ](https://github.com/toppers/hakoniwa-px4sim/blob/main/hakoniwa/README.md#機体のパラメータ説明)は、[drone_config.py](https://github.com/toppers/hakoniwa-px4sim/blob/main/hakoniwa/python/drone_config.py)で設定できます。

このスクリプトを使用して、指定されたJSONファイル内の値を更新できます。

### 使い方

スクリプトはコマンドラインから次のように実行されます：

```
python drone_config.py <json_file> <path> <new_value>
```

### 引数

- `json_file`: 更新するJSONファイルへのパスを指定します。
- `path`: 更新する要素へのドット区切りパス。例えば、`components.droneDynamics.mass_kg`のように指定します。
- `new_value`: 要素に設定する新しい値。値の型は自動的に元の値の型に合わせて変換されます。

### 値の型変換

プログラムは、新しい値を次のルールに従って適切な型に変換します：

- 整数（`int`）への変換が必要な場合、新しい値は整数に変換されます。
- 浮動小数点数（`float`）への変換が必要な場合、新しい値は浮動小数点数に変換されます。
- 文字列（`str`）への変換が必要な場合、新しい値は文字列に変換されます。
- 真偽値（`bool`）への変換が必要な場合、`"true"`または`"false"`の文字列が真偽値に変換されます。
- JSON配列やオブジェクトなど、その他のデータ型を更新する場合、適切なJSON形式の文字列を使用します（例: `'[0.015, 0.015, 0.03]'`）。

### エラーハンドリング

- もし指定したパスが存在しない場合、プログラムはエラーメッセージを出力します。
- もし指定したキーが存在しない場合、プログラムはエラーメッセージを出力します。
- 型変換に失敗した場合、プログラムはエラーメッセージを出力します。

### 実行例

JSONファイル内の`components.droneDynamics.mass_kg`の値を`1.5`に更新するには、次のコマンドを実行します：

```
python drone_config.py path_to_file.json components.droneDynamics.mass_kg 1.5
```

### 注意

- このスクリプトは、コマンドライン引数として有効なJSONファイルのパスと、更新する要素の有効なパス、そして有効な新しい値が提供されることを前提としています。
- JSONファイルはプログラムによって上書きされます。元のファイルのバックアップを取っておくことを推奨します。


## Test Scenario

TODO

## Test Scenario Executor

TODO

## Logs / LogOutputDirectory

TODO

## Test Result Evaluator

TODO

# テスト実行方法

TODO

